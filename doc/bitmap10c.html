<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>DarkCPU: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DarkCPU
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('bitmap10c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#Bitmap">Bitmap</a><ul><li class="level2"><a href="#bitmapDetails">Module Details</a></li>
<li class="level2"><a href="#Bitmaps">Bitmaps</a></li>
</ul>
</li>
<li class="level1"><a href="#DASMDOC_S10">Functions</a><ul><li class="level2"><a href="#DASMDOC_S11">bitmap_set</a></li>
<li class="level2"><a href="#DASMDOC_S12">bitmap_clear</a></li>
<li class="level2"><a href="#DASMDOC_S13">bitmap_get</a></li>
<li class="level2"><a href="#DASMDOC_S14">bitmap_nandRun</a></li>
<li class="level2"><a href="#DASMDOC_S15">bitmap_findClearRun</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h2>bitmap10c</h2>
<h1><a class="anchor" id="Bitmap"></a>
Bitmap</h1>
<h2><a class="anchor" id="bitmapDetails"></a>
Module Details</h2>
<p>This module contains several routines for optimally handling a bitmap. It is used internally for things such as memory and mutex allocation bitmaps, however the routines are also exported via the kernel's export table. </p>
<dl class="section author"><dt>Author</dt><dd>Jeremy (0x10cforums.com) </dd></dl>
<dl class="section version"><dt>Version</dt><dd>1.0 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>Dec, 18, 2012</dd></dl>
<hr/>
<h2><a class="anchor" id="Bitmaps"></a>
Bitmaps</h2>
<p>A bitmap is a large array of bits which are mapped to represent a property of each object in a array of objects in memory. It is simply an array of boolean data types only each element in the array only consumes a single bit of memory. If an array of many objects in memory needs to have a particular property of them stored, and that property ranges between only two discrete values, a bitmap can be mapped to this array of objects to represent a this property of each individual object. Using bitmaps allow for optimal storage of a property for an array of objects.</p>
<p>An example of its application would be inside of DarkCPU's memory manager. DarkCPU's memory manager uses a bitmap to describe the state of each individual Memory Chunk in memory. Since there are over a thousand chunks, representing each chunk with a word or a byte of data would cause an excessive waste of memory. Instead, a bitmap is used. Since there are about 1024 memory chunks in memory, and each word is 16 bits, the size of the memory allocation bitmap would only be 64 words in size.</p>
<h1><a class="anchor" id="DASMDOC_S10"></a>
Functions</h1>
<hr/>
 <h2><a class="anchor" id="DASMDOC_S11"></a>
bitmap_set</h2>
<p><a class="el" href="calling_conventions.html#cdecl">cdecl</a> VOID bitmap_set(<code>WORD</code> wBitIndex, <code>WORD*</code> pBitmapBase) <br/>
<br/>
<b>Description:</b><br/>
 Used to set a single bit in bitmap. If more than one adjacent bits are to be set, it is much more optimal to use the bitmap_nandRun procedure. <br/>
</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">wBitIndex</td><td><code>WORD</code> The Index, in terms of bits, into the bitmap describing which bit is to be set in the specified bitmap. </td></tr>
    <tr><td class="paramname">pBitmapBase</td><td><code>WORD*</code> The base address of the bitmap in memory. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>VOID</code> <br/>
</dd></dl>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line">_sfBegin(0)</div>
<div class="line"></div>
<div class="line">_sfArg(y, 0)</div>
<div class="line">_sfArg(c, 1)</div>
<div class="line"></div>
<div class="line">set a, 0x8000               ; Create mask, Only MSB set</div>
<div class="line"></div>
<div class="line">div y, 16                   ; Calculate in which WORD this bit belongs to. There are 16 bits per word</div>
<div class="line">shr ex, 12</div>
<div class="line">shr a, ex</div>
<div class="line"></div>
<div class="line">add c, y                    ; Add this offset to the base</div>
<div class="line">bor [c], a                  ; AND mask with bitmap</div>
<div class="line"></div>
<div class="line">_sfEnd()</div>
<div class="line">ret</div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S12"></a>
bitmap_clear</h2>
<p><a class="el" href="calling_conventions.html#cdecl">cdecl</a> VOID bitmap_clear(<code>WORD</code> wBitIndex, <code>WORD*</code> pBitmapBase) <br/>
<br/>
<b>Description:</b><br/>
 Used to clear a single bit in bitmap. If more than one adjacent bit is to be cleared, it is much more optimal to use the bitmap_nandRun procedure. <br/>
</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">wBitIndex</td><td><code>WORD</code> The Index, in terms of bits, into the bitmap describing which bit is to be cleared in the specified bitmap. </td></tr>
    <tr><td class="paramname">pBitmapBase</td><td><code>WORD*</code> The base address of the bitmap in memory. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>VOID</code> <br/>
</dd></dl>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line">_sfBegin(0)</div>
<div class="line"></div>
<div class="line">_sfArg(y, 0)</div>
<div class="line">_sfArg(c, 1)</div>
<div class="line"></div>
<div class="line">set a, 0x8000               ; Create mask, Only MSB set</div>
<div class="line"></div>
<div class="line">div y, 16                   ; Calculate in which WORD this bit belongs to. There are 16 bits per word</div>
<div class="line">shr ex, 12</div>
<div class="line">shr a, ex                   ; Shift mask over x bits, where x is the mod of the above devision</div>
<div class="line">xor a, 0xFFFF</div>
<div class="line">    </div>
<div class="line">add c, y                    ; Add this offset to the base</div>
<div class="line">AND [c], a                  ; XOR mask with bitmap</div>
<div class="line"></div>
<div class="line">_sfEnd()</div>
<div class="line">ret </div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S13"></a>
bitmap_get</h2>
<p><a class="el" href="calling_conventions.html#cdecl">cdecl</a> BOOL bitmap_get(<code>WORD</code> wBitIndex, <code>WORD*</code> pBitmapBase) <br/>
<br/>
<b>Description:</b><br/>
 Gets the state of a single specified bit in a bitmap. <br/>
</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">wBitIndex</td><td><code>WORD</code> The Index, in terms of bits, into the bitmap describing which bit is to have its state acquired. </td></tr>
    <tr><td class="paramname">pBitmapBase</td><td><code>WORD*</code> The base address of the bitmap in memory. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>BOOL</code> The state of the bit, TRUE if set. <br/>
</dd></dl>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line">_sfBegin(0)</div>
<div class="line"></div>
<div class="line">_sfArg(y, 0)</div>
<div class="line">_sfArg(c, 1)</div>
<div class="line"></div>
<div class="line">set a, 0x8000               ; Create mask, Only MSB set</div>
<div class="line"></div>
<div class="line">div y, 16                   ; Calculate in which WORD this bit belongs to. There are 16 bits in a word</div>
<div class="line">shr ex, 12</div>
<div class="line">shr a,ex                    ; Shift mask over x bits, where x is the mod of the above devision</div>
<div class="line"></div>
<div class="line">add c, y                    ; Add this offset to the base</div>
<div class="line">and a, [c]                  ; AND mask with bitmap</div>
<div class="line"></div>
<div class="line">_sfEnd()</div>
<div class="line">ret </div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S14"></a>
bitmap_nandRun</h2>
<p><a class="el" href="calling_conventions.html#cdecl">cdecl</a> VOID bitmap_nandRun(<code>WORD*</code> pBaseAddress, <code>WORD</code> wStartIndex, <code>WORD</code> wRunLength, <code>WORD</code> wMask) <br/>
<br/>
<b>Description:</b><br/>
 This function is specifically designed such that is can clear and set data. To perform a clear using the NAND operation, your mask must be equal to 0xFFFF. To perform a set run operation, you can use 0x0000 <br/>
</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pBaseAddress</td><td><code>WORD*</code> The base address of the bitmap to perform this operation on </td></tr>
    <tr><td class="paramname">wStartIndex</td><td><code>WORD</code> The index of the first bit of the series of bits that this operation will be applied to. </td></tr>
    <tr><td class="paramname">wRunLength</td><td><code>WORD</code> The number of bits to perform this operation on, starting from wStartIndex </td></tr>
    <tr><td class="paramname">wMask</td><td><code>WORD</code> Mask to apply to words when performing the NOR operation. This can be either 0x0000 or 0xFFFF Anything else will result in undefined behaviour </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>VOID</code> <br/>
</dd></dl>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line">;Bitmap indexing is usually a cpu intensive operation and thus we optimize the looping as much as possible by <span class="keyword">using</span> registers.</div>
<div class="line">_sfBegin(0)</div>
<div class="line">_push x</div>
<div class="line"></div>
<div class="line">;Due to alignment, the first word must be done individually to simplify &amp; optimize the logic in the following loop:</div>
<div class="line">_sfArg(y, 1)    ;Calculate the bit index into the first word that contains the start index described in the arguments</div>
<div class="line">mod y, 16</div>
<div class="line"></div>
<div class="line">;Ignore warnings, trick used to overflow ex <span class="keyword">register</span> and quickly obtain a desired mask</div>
<div class="line">shr 0xFFFF, y   ;Create a bitmap that covers the bits we want to leave alone (i.e, preceed the start index bit)</div>
<div class="line"><span class="keyword">set</span> c, ex</div>
<div class="line">        </div>
<div class="line"><span class="keyword">set</span> x, 0</div>
<div class="line">add x, y</div>
<div class="line"></div>
<div class="line">_sfArgAdd(x, 2)</div>
<div class="line">ifg x, 16</div>
<div class="line">    set x, 16</div>
<div class="line"></div>
<div class="line">set a, 0xFFFF</div>
<div class="line">shr a, x</div>
<div class="line">bor c, a        ;This bitmask stored in c defines a mask for protecting the bits we want to leave alone during the nand operation.</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">sub x, y        ;Calculate how many bits we applied the nand operation on, and subtract it from the total amount of bits it must be performed on.</div>
<div class="line">_sfArg(y, 2)    ;Where y now holds the amount of bits left to perform the nand operation on.</div>
<div class="line">sub y, x</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">_sfArg(a, 1)</div>
<div class="line">div a, 16</div>
<div class="line">_sfArgAdd(a, 0)</div>
<div class="line"></div>
<div class="line">;Now setup mask on word:</div>
<div class="line">_sfArg(x, 3)</div>
<div class="line">bor x, c ;This is our AND mask</div>
<div class="line"></div>
<div class="line">and [a], x</div>
<div class="line">xor c, 0xFFFF</div>
<div class="line">xor [a], c</div>
<div class="line">add a, 1</div>
<div class="line"></div>
<div class="line">bitmap_nandRun_nandBitsLoop:</div>
<div class="line">    ife y, 0</div>
<div class="line">        jmp bitmap_nandRun_nandBits_end</div>
<div class="line">    </div>
<div class="line">    set c, y</div>
<div class="line">    </div>
<div class="line">    ifg c, 16</div>
<div class="line">        set c, 16</div>
<div class="line">        </div>
<div class="line">    sub y, c</div>
<div class="line"></div>
<div class="line">    sub c, 16</div>
<div class="line">    xor c, 0xFFFF</div>
<div class="line">    add c, 1</div>
<div class="line"></div>
<div class="line">    ;Ignore warnings, trick used to overflow ex register and quickly obtain a desired mask</div>
<div class="line">    shl 0xFFFF, c</div>
<div class="line">    set c, ex</div>
<div class="line">    _sfArg(x, 3)</div>
<div class="line">    bor x, c</div>
<div class="line">    and [a], x</div>
<div class="line">    xor c, 0xFFFF</div>
<div class="line">    xor [a], c          </div>
<div class="line">    </div>
<div class="line">    add a, 1</div>
<div class="line">    </div>
<div class="line">    jmp bitmap_nandRun_nandBitsLoop</div>
<div class="line">    </div>
<div class="line">bitmap_nandRun_nandBits_end:</div>
<div class="line">_pop x</div>
<div class="line">_sfEnd()</div>
<div class="line">ret </div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S15"></a>
bitmap_findClearRun</h2>
<p><a class="el" href="calling_conventions.html#cdecl">cdecl</a> WORD bitmap_findClearRun(<code>WORD*</code> pBaseAddress, <code>WORD</code> wSize, <code>WORD</code> wSeekCount) <br/>
<br/>
<b>Description:</b><br/>
 <br/>
</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pBaseAddress</td><td><code>WORD*</code> The base address of the bitmap to perform this operation on </td></tr>
    <tr><td class="paramname">wSize</td><td><code>WORD</code> The size of the bitmap in words </td></tr>
    <tr><td class="paramname">wSeekCount</td><td><code>WORD</code> The number of contigous clear bits to find. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>WORD</code> Returns the index of the first bit in the found contigous sequence of clear bits, or 0xFFFF if no contigous array of clear bits of the specified length was found. <br/>
</dd></dl>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line">    _sfBegin(0)</div>
<div class="line">    </div>
<div class="line">    _push i                                                 ;registers used to optimize intensive iteration of the allocation table.</div>
<div class="line">    _push x</div>
<div class="line">    _push z</div>
<div class="line">    </div>
<div class="line">    set i, 0                                                ;current word index into memory_allocationBitmap</div>
<div class="line">    </div>
<div class="line">    _sfArg(y, 2)                                            ;number of free bits that need to be found</div>
<div class="line">    </div>
<div class="line">    ;Find a contigous series of 0s in the bitmap.</div>
<div class="line">    </div>
<div class="line">    bitmap_findClearRun_findWord:</div>
<div class="line">        _sfArgIfEquals(1, i)                                    ;If our current word index is outside of our allocation bitmap&#39;s range</div>
<div class="line">            jmp bitmap_findClearRun_noRun                   ;and we have not found a free memory region, there is an insufficient amount of contiguous memory accessible by the system.</div>
<div class="line">            </div>
<div class="line">        set a, y</div>
<div class="line">        </div>
<div class="line">        ifg a, 16                                           ;clamp number of bits that must be found contiguous in this word to a max of 16 (since there are only 16 bits in a word.)</div>
<div class="line">            set a, 16</div>
<div class="line">        </div>
<div class="line">        set c, 0x8000                                       ;Setup the bitcount to zero</div>
<div class="line">        set x, 0</div>
<div class="line"></div>
<div class="line">        _sfArg(z, 0)                                        ;Calculate the word the value of the word at the current word index in our bitmap</div>
<div class="line">        add z, i</div>
<div class="line">        set z, [z]</div>
<div class="line">        </div>
<div class="line">        _push a                                             ;push &#39;a&#39; to the stack so that its original value can be qucikly recalled when the variable needs to be reset </div>
<div class="line">        bitmap_findClearRun_findbitsLoop:</div>
<div class="line"></div>
<div class="line">            sub a, 1                                        ;Assume the next bit is cleared, and subtract from the number of bits which need to be found</div>
<div class="line">            ifb z, c                                    ;if in reality it isn&#39;t, the variable is reset anyways.</div>
<div class="line">                set a, [sp]                                 ;Reset a to its initial value. We cannot use the bits if they are not contigous.</div>
<div class="line"></div>
<div class="line">            add x, 1                                        ;increment x, so that it represents the number of bits searched</div>
<div class="line">            </div>
<div class="line">            ife a, 0                                        </div>
<div class="line">                jmp bitmap_findClearRun_findbits_end        ;if a is equal to zero, we have seeked through all the bits required.</div>
<div class="line">            </div>
<div class="line">            shr c, 1                                        ;shift our bitmap over 1 to check the state of the following bit</div>
<div class="line">            </div>
<div class="line">            ifn ex, 0                                       ;if the above shift overflowed the c register (ex != 0), we have completed seeking through all the bits in this word, and thus end the bit search.</div>
<div class="line">                jmp bitmap_findClearRun_findbits_end</div>
<div class="line"></div>
<div class="line">            jmp bitmap_findClearRun_findBitsLoop</div>
<div class="line">                                                            </div>
<div class="line">        bitmap_findClearRun_findbits_end:</div>
<div class="line">            _pop c                                          ;Pop off the number of bits that we were trying to find</div>
<div class="line">            sub c, a                                        ;Subtract from the number of bits we were trying to find by the number of more we needed to find to achieve this, which will gives us the number of bits found.</div>
<div class="line"></div>
<div class="line">            ifn c, x                                        ;If the number of bits processed is not equal to the number of free found bits, the search for a contigous array of zeros was interrupted by a 1</div>
<div class="line">                _sfArg(y, 2)                                ;thus we must reset y</div>
<div class="line">            </div>
<div class="line">            ;Subtract y by the number of bits found</div>
<div class="line">            sub y, c                                        ;Subtract from the total number of bits we must find by the number of free bits found</div>
<div class="line">            </div>
<div class="line">            ife y, 0                                        ;If no more bits must be found, we found all the memory we need</div>
<div class="line">                jmp bitmap_findClearRun_foundRun</div>
<div class="line">                    </div>
<div class="line">    bitmap_findClearRun_findWordNext:</div>
<div class="line">        </div>
<div class="line">        add i, 1                                            ;advance forward to the next word in memory</div>
<div class="line">        jmp bitmap_findClearRun_findWord</div>
<div class="line">        </div>
<div class="line">bitmap_findClearRun_foundRun:</div>
<div class="line">    ;Calculate the index of the last contigous bit found</div>
<div class="line">    set a, i</div>
<div class="line">    mul a, 16</div>
<div class="line">    add a, x</div>
<div class="line"></div>
<div class="line">    _sfArg(c, 2)</div>
<div class="line"></div>
<div class="line">    sub a, c</div>
<div class="line">    </div>
<div class="line">bitmap_findClearRun_end:</div>
<div class="line">    _pop z</div>
<div class="line">    _pop x                                                  ;Restore the state of the z, x, i registers</div>
<div class="line">    _pop i</div>
<div class="line"></div>
<div class="line">    _sfEnd()</div>
<div class="line">    ret</div>
<div class="line"></div>
<div class="line">bitmap_findClearRun_noRun:</div>
<div class="line"></div>
<div class="line">    set a, 0xFFFF                                           ;return 0xFFFF to symbolize that there was an error allocating memory.</div>
<div class="line"></div>
<div class="line">    jmp bitmap_findClearRun_end </div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="md__code.html">Code</a></li>
    <li class="footer">Generated on Sat Apr 13 2013 17:37:42 for DarkCPU by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
