<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>DarkCPU: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DarkCPU
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('pe_loader10c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#PeLoader">PeLoader</a><ul><li class="level2"><a href="#peLoaderDetails">Module Details</a></li>
<li class="level2"><a href="#peLoaderExec">Decription of Executables</a></li>
<li class="level2"><a href="#peLoaderExportTable">Export Table</a></li>
<li class="level2"><a href="#peLoaderImportExport">IAT/EAT</a></li>
<li class="level2"><a href="#peLoaderPeFlags">Flags & Next</a></li>
<li class="level2"><a href="#peLoaderRelocTable">Relocation Table</a></li>
</ul>
</li>
<li class="level1"><a href="#DASMDOC_S91">Constants</a><ul><li class="level2"><a href="#DASMDOC_S92">PEIMAGE_SIGNATURE</a></li>
<li class="level2"><a href="#DASMDOC_S93">PEIMAGE_NAMELEN</a></li>
<li class="level2"><a href="#DASMDOC_S94">PEIMAGE_INVALID_NEXT</a></li>
<li class="level2"><a href="#DASMDOC_S95">PEIMAGE_INVALID_IMPORT</a></li>
<li class="level2"><a href="#DASMDOC_S96">PEIMAGE_INVALID_EXPORT</a></li>
<li class="level2"><a href="#DASMDOC_S97">PEIMAGE_OFFSET_SIGNATURE</a></li>
<li class="level2"><a href="#DASMDOC_S98">PEIMAGE_OFFSET_PEFLAGS</a></li>
<li class="level2"><a href="#DASMDOC_S99">PEIMAGE_OFFSET_NEXT</a></li>
<li class="level2"><a href="#DASMDOC_S100">PEIMAGE_OFFSET_NAME</a></li>
<li class="level2"><a href="#DASMDOC_S101">PEIMAGE_OFFSET_RVA_ENTRY_POINT</a></li>
<li class="level2"><a href="#DASMDOC_S102">PEIMAGE_OFFSET_RVA_IMPORT_TABLE</a></li>
<li class="level2"><a href="#DASMDOC_S103">PEIMAGE_OFFSET_RVA_EXPORT_TABLE</a></li>
<li class="level2"><a href="#DASMDOC_S104">PEIMAGE_OFFSET_RVA_RELOCATION_TABLE</a></li>
<li class="level2"><a href="#DASMDOC_S105">PEIMAGE_OFFSET_IMAGE_SIZE</a></li>
<li class="level2"><a href="#DASMDOC_S106">PEIMAGE_OFFSET_IMAGE_MD5SPECHASH</a></li>
<li class="level2"><a href="#DASMDOC_S107">PEIMAGE_PEFLAG_FORCEINIT</a></li>
</ul>
</li>
<li class="level1"><a href="#DASMDOC_S108">Data</a><ul><li class="level2"><a href="#DASMDOC_S109">peLoader_root</a></li>
</ul>
</li>
<li class="level1"><a href="#DASMDOC_S110">Functions</a><ul><li class="level2"><a href="#DASMDOC_S111">peLoader_loadImage</a></li>
<li class="level2"><a href="#DASMDOC_S112">peLoader_initImage</a></li>
<li class="level2"><a href="#DASMDOC_S113">peLoader_findLastImage</a></li>
<li class="level2"><a href="#DASMDOC_S114">peLoader_findImage</a></li>
<li class="level2"><a href="#DASMDOC_S115">peLoader_findImageEx</a></li>
<li class="level2"><a href="#DASMDOC_S116">peLoader_findExport</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h2>peLoader10c</h2>
<h1><a class="anchor" id="PeLoader"></a>
PeLoader</h1>
<h2><a class="anchor" id="peLoaderDetails"></a>
Module Details</h2>
<p>This module contains various functions that can be used to load executable images, drivers and librarys into memory and begin executing them. </p>
<dl class="section author"><dt>Author</dt><dd>Jeremy (0x10cforums.com) </dd></dl>
<dl class="section version"><dt>Version</dt><dd>1.0 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>Dec, 14, 2012</dd></dl>
<hr/>
<h2><a class="anchor" id="peLoaderExec"></a>
Decription of Executables</h2>
<p>Any given executable module in darkcpu can export, import and access kernel level routines to communicate with hardware devices. As such, all executable images can act as either a library, a driver, an application or a hybrid between all three. Each executable image can define or omit an entrypoint in the header, this entrypoint defines where the task's initial thread is created (if the entrypoint is omitted in the image header, no thread is created for the executable image when it is loaded.)</p>
<p>Executable images are initialized in memory by using the <a class="el" href="pe_loader10c.html#PeLoader">PeLoader</a> module, and are structured in memory as a linked list. Each initialized executable image has a 'next' member of sorts inside of the image's header that points towards the next executable image in the chain. The kernel uses this linked list to keep track of all the exeuctables loaded in memory. The root of this linked list is always the kernel image.</p>
<hr/>
<h2><a class="anchor" id="peLoaderExportTable"></a>
Export Table</h2>
<p><a class="anchor" id="ExportAddressTable"></a>The export table describes which routines to export to other tasks running on the system such that these exports can be located and called upon through another task. The export table consists of a list of RVelative Virtual Addresses (RVAs) to functions which are exported. Each export in the table has a corresponding 'ordinal' which is equal the index of that entry in the export table. This ordinal value is used by other modules to locate specific exported routines from the executable image.</p>
<p>As the export table contains a list of RVAs, once the executable image is loaded into memory, the loader will add the image's base address to every entry in its export table, effectivley translating these relative addresses to the actual address of the exported data.</p>
<hr/>
<h2><a class="anchor" id="peLoaderImportExport"></a>
IAT/EAT</h2>
<p>The import table of an executable image doubles as the import address table and the import table. When the executable image is initialized by the <a class="el" href="pe_loader10c.html#PeLoader">PeLoader</a>, its import table is replaced with the appropriate import address table. The difference between the two is described below.</p>
<p>An import table describes which routines need to be imported from other loaded executable images in the system. The import table consists of a series of ModuleImport structure and is terminated with a word equal to PEIMAGE_INVALID_IMPORT. The layout of a ModuleImport structure is defined below:</p>
<p>Members of ModuleImport (In Order)</p>
<ul>
<li>Name of module to import functions from (size is PEIMAGE_NAMELEN padded with null)</li>
<li>List of ordinal values (each entry will be replaced with the address of the import they refer to when loaded in memory.)</li>
<li>Module Import Entry terminated with PEIMAGE_INVALID_IMPORT Another ModuleImport Entry ...</li>
<li>Module Import Entry terminated with PEIMAGE_INVALID_IMPORT ...</li>
<li>Import Table terminated with a PEIMAGE_INVALID_IMPORT</li>
</ul>
<p><a class="anchor" id="PeFlags"></a> </p>
<h2>peLoaderPeFlags Flags &amp; Next</h2>
<p>When loading the executable, this member is treated as PeFlags, which defines how to load the module. This flags are described in the table below.</p>
<p>Once image has been loaded in to memory, this member is treated as a pointer to the next executable image loaded in memory as per a linked list structure.</p>
<dl class="section warning"><dt>Warning</dt><dd>after an executable image has been loaded into memory, the PeFlags are destroyed and should be treated as 'Next'.</dd></dl>
<table class="doxtable">
<tr>
<th>Flag </th><th>Description</th></tr>
<tr>
<td>PEIMAGE_PEFLAG_FORCEINIT </td><td>Forces the applications entrypoint to be invoked and then to return before execution continues. </td></tr>
</table>
<hr/>
 <h2><a class="anchor" id="peLoaderRelocTable"></a>
Relocation Table</h2>
<dl class="section note"><dt>Note</dt><dd>Not yet implemented.</dd></dl>
<h2>peLoaderLayout Executable Image Format</h2>
<p>The layout of an executable image is as follows:</p>
<table class="doxtable">
<tr>
<th>Offset </th><th>Member Name </th><th>Description of Member</th></tr>
<tr>
<td>PEIMAGE_OFFSET_SIGNATURE </td><td>ImageSignature </td><td>Stores the signature of an executable image. This is equal to PEIMAGE_SIGNATURE for all valid executable images and is used to identify a valid Executable Image </td></tr>
<tr>
<td>PEIMAGE_OFFSET_NEXT, PEIMAGE_OFFSET_PEFLAGS </td><td>{Next, PeFlags} </td><td>Pointer to the next executable image in the linked list, or PEIMAGE_INVALID_NEXT if the current entry is the last in the chain of executable images. Used by the kernel to keep track of executable images and should not be used by the user </td></tr>
<tr>
<td>PEIMAGE_OFFSET_NAME </td><td>Name </td><td>Name of the module. This is used to identify the module in memory and located any of its exported data. Other executable images will use this name in their import table to find data exported by this module. The name has a max size of PEIMAGE_NAMELEN </td></tr>
<tr>
<td>PEIMAGE_OFFSET_RVA_ENTRY_POINT </td><td>RvaEntryPoint </td><td>Describes the RVA of the module's entry point where its first thread is created. Uses the asyncCall calling convention. If this is equal to zero, it will be loaded as usual but will not have a thread created for it </td></tr>
<tr>
<td>PEIMAGE_OFFSET_RVA_IMPORT_TABLE </td><td>RvaImportTable </td><td>Describes the RVA of the module's import table, or zero if the module does not have an import table. </td></tr>
<tr>
<td>PEIMAGE_OFFSET_RVA_EXPORT_TABLE </td><td>RvaExportTable </td><td>Describes the RVA of the module's export table, or zero if the module does not have an export table. </td></tr>
<tr>
<td>PEIMAGE_OFFSET_RVA_RELOCATION_TABLE </td><td>RvaRelocations </td><td>Describes the RVA of the module's relocations table, or zero if the module does not have a relocation table. </td></tr>
<tr>
<td>PEIMAGE_OFFSET_IMAGE_SIZE </td><td>ImageSize </td><td>Describes the size of the executable memory </td></tr>
<tr>
<td>PEIMAGE_OFFSET_IMAGE_MD5SPECHASH </td><td>MD5SpecHash </td><td>The origin of the 8 word MD5SpecHash for the module (MD5SpecHash), or 0 if this module does not implement a particular specification. This hash is stored such that the upper most significant word of the hash is stored here. It is followed, in order of decending significance, by the remaining words of the hash. </td></tr>
<tr>
<td>PEIMAGE_OFFSET_IMAGE_MD5SPECHASH + 1 </td><td>Remaining 7 words of hash </td><td>Where the remaining for the MD5SpecHash is stored. </td></tr>
<tr>
<td>... </td><td>Code or data Section </td><td>Where image data or code is stored </td></tr>
</table>
<dl class="section attention"><dt>Attention</dt><dd>The PE Image format is highly subject to change at this stage in development. Some entries which may be introduced are the reference counter and the initial stack size. Others may be introduced as well, throwing off the alignment of the table you see above.</dd></dl>
<h1><a class="anchor" id="DASMDOC_S91"></a>
Constants</h1>
<hr/>
 <h2><a class="anchor" id="DASMDOC_S92"></a>
PEIMAGE_SIGNATURE</h2>
<p><code>WORD</code> PEIMAGE_SIGNATURE <br/>
<br/>
<b>Description:</b><br/>
 PEIMAGE_SIGNATURE This defines the first word in every executable image that validates it is an executable image. The <a class="el" href="pe_loader10c.html#PeLoader">PeLoader</a> will fail to load exeuctable images which do not poses this signature as their first byte. <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PEIMAGE_SIGNATURE 0x10C</span></div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S93"></a>
PEIMAGE_NAMELEN</h2>
<p><code>WORD</code> PEIMAGE_NAMELEN <br/>
<br/>
<b>Description:</b><br/>
 This defines the number of words allocated for the module's name in the Executable Image File's Name member, refer to PeImageFormat. <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PEIMAGE_NAMELEN   10</span></div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S94"></a>
PEIMAGE_INVALID_NEXT</h2>
<p><code>WORD</code> PEIMAGE_INVALID_NEXT <br/>
<br/>
<b>Description:</b><br/>
 Defines the value given to an invalid next entry, usually meaning that there are no more entries in the chain. Refer to PeImageFormat <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PEIMAGE_INVALID_NEXT 0xFFFF</span></div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S95"></a>
PEIMAGE_INVALID_IMPORT</h2>
<p><code>WORD</code> PEIMAGE_INVALID_IMPORT <br/>
<br/>
<b>Description:</b><br/>
 Defines the value given to an invalid import entry, usually meaning that there are no more entries in the import table. Refer to PeImageFormat <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PEIMAGE_INVALID_IMPORT 0xFFFF</span></div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S96"></a>
PEIMAGE_INVALID_EXPORT</h2>
<p><code>WORD</code> PEIMAGE_INVALID_EXPORT <br/>
<br/>
<b>Description:</b><br/>
 Defines the value given to an invalid export entry, usually meaning that there are no more entries in the export table. Refer to PeImageFormat <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PEIMAGE_INVALID_EXPORT 0xFFFF</span></div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S97"></a>
PEIMAGE_OFFSET_SIGNATURE</h2>
<p><code>WORD</code> PEIMAGE_OFFSET_SIGNATURE <br/>
<br/>
<b>Description:</b><br/>
 Offset to the image's PEIMAGE structure pointing to the signature member. Refer to PeImageFormat <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PEIMAGE_OFFSET_SIGNATURE 0</span></div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S98"></a>
PEIMAGE_OFFSET_PEFLAGS</h2>
<p><code>WORD</code> PEIMAGE_OFFSET_PEFLAGS <br/>
<br/>
<b>Description:</b><br/>
 Flags for loading of PEImage. Refer to PeImageFormat <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PEIMAGE_OFFSET_PEFLAGS 1</span></div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S99"></a>
PEIMAGE_OFFSET_NEXT</h2>
<p><code>WORD</code> PEIMAGE_OFFSET_NEXT <br/>
<br/>
<b>Description:</b><br/>
 Offset to the image's PEIMAGE structure pointing to the NEXT member. Refer to PeImageFormat <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PEIMAGE_OFFSET_NEXT 1</span></div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S100"></a>
PEIMAGE_OFFSET_NAME</h2>
<p><code>WORD</code> PEIMAGE_OFFSET_NAME <br/>
<br/>
<b>Description:</b><br/>
 Offset to the image's PEIMAGE structure pointing to the NAME member. Refer to PeImageFormat <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PEIMAGE_OFFSET_NAME 2</span></div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S101"></a>
PEIMAGE_OFFSET_RVA_ENTRY_POINT</h2>
<p><code>WORD</code> PEIMAGE_OFFSET_RVA_ENTRY_POINT <br/>
<br/>
<b>Description:</b><br/>
 Offset to the image's PEIMAGE structure pointing to the RVA_ENTRY_POINT member. Refer to PeImageFormat <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PEIMAGE_OFFSET_RVA_ENTRY_POINT    12</span></div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S102"></a>
PEIMAGE_OFFSET_RVA_IMPORT_TABLE</h2>
<p><code>WORD</code> PEIMAGE_OFFSET_RVA_IMPORT_TABLE <br/>
<br/>
<b>Description:</b><br/>
 Offset to the image's PEIMAGE structure pointing to the RVA_IMPORT_TABLE member. Refer to PeImageFormat <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PEIMAGE_OFFSET_RVA_IMPORT_TABLE 13</span></div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S103"></a>
PEIMAGE_OFFSET_RVA_EXPORT_TABLE</h2>
<p><code>WORD</code> PEIMAGE_OFFSET_RVA_EXPORT_TABLE <br/>
<br/>
<b>Description:</b><br/>
 Offset to the image's PEIMAGE structure pointing to the PEIMAGE_OFFSET_RVA_EXPORT_TABLE member. Refer to PeImageFormat <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PEIMAGE_OFFSET_RVA_EXPORT_TABLE 14</span></div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S104"></a>
PEIMAGE_OFFSET_RVA_RELOCATION_TABLE</h2>
<p><code>WORD</code> PEIMAGE_OFFSET_RVA_RELOCATION_TABLE <br/>
<br/>
<b>Description:</b><br/>
 Offset to the image's PEIMAGE structure pointing to the PEIMAGE_OFFSET_RVA_EXPORT_TABLE member. Refer to PeImageFormat <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PEIMAGE_OFFSET_RVA_RELOCATION_TABLE 15</span></div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S105"></a>
PEIMAGE_OFFSET_IMAGE_SIZE</h2>
<p><code>WORD</code> PEIMAGE_OFFSET_IMAGE_SIZE <br/>
<br/>
<b>Description:</b><br/>
 Offset to the image's PEIMAGE structure pointing to the RVA_IMAGE_SIZE member. Refer to PeImageFormat <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PEIMAGE_OFFSET_IMAGE_SIZE         16</span></div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S106"></a>
PEIMAGE_OFFSET_IMAGE_MD5SPECHASH</h2>
<p><code>WORD</code> PEIMAGE_OFFSET_IMAGE_MD5SPECHASH <br/>
<br/>
<b>Description:</b><br/>
 Offset to the image's PEIMAGE structure pointing to the MD5SpecHash member. Refer to PeImageFormat <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PEIMAGE_OFFSET_IMAGE_MD5SPECHASH 17</span></div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S107"></a>
PEIMAGE_PEFLAG_FORCEINIT</h2>
<p><code>WORD</code> PEIMAGE_PEFLAG_FORCEINIT <br/>
<br/>
<b>Description:</b><br/>
 PeImage loading flag. Refer to PeImageFormat <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PEIMAGE_PEFLAG_FORCEINIT 0x1</span></div>
</div><!-- fragment --><h1><a class="anchor" id="DASMDOC_S108"></a>
Data</h1>
<hr/>
 <h2><a class="anchor" id="DASMDOC_S109"></a>
peLoader_root</h2>
<p><code>IMAGE*</code> peLoader_root <br/>
<br/>
<b>Description:</b><br/>
 Points to first entry in the linked list of excecutable images. Stores the first entry in the linked list of executable images loaded into memory. This is always the kernel. <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line">DAT kernel_image_header</div>
</div><!-- fragment --><h1><a class="anchor" id="DASMDOC_S110"></a>
Functions</h1>
<hr/>
 <h2><a class="anchor" id="DASMDOC_S111"></a>
peLoader_loadImage</h2>
<p><a class="el" href="calling_conventions.html#cdecl">cdecl</a> STATUS peLoader_loadImage(<code>FILE*</code> pFile, <code>FILE*</code> pSourceDirectory) <br/>
<br/>
<b>Description:</b><br/>
 Loads an executable image from the filesystem and Initializes it. This perfroms similar to peLoader_initProcess, only it first loads an image from the filesystem and then initilizes it. <br/>
</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pFile</td><td><code>FILE*</code> A pointer to the file descriptor of the file to be loaded into memory. </td></tr>
    <tr><td class="paramname">pSourceDirectory</td><td><code>FILE*</code> A pointer to a file descriptor of the directory where dependencies are looked for. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>STATUS</code> Returns a 0 on error, or the base address of the loaded executable if it was loaded successfully. <br/>
</dd></dl>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line">    _sfBegin(1)</div>
<div class="line">    _sfArg(c, 0)</div>
<div class="line">    </div>
<div class="line">    set a, [c + VFS_FILE_OFFSET_LENGTH] ;Get file size in bytes and align it in to words</div>
<div class="line">    div a, 2</div>
<div class="line">    ifn ex, 0</div>
<div class="line">        add a, 1</div>
<div class="line">        </div>
<div class="line">    _sfLocalSet(0, a) ;Store the size as a local variable</div>
<div class="line">    </div>
<div class="line">    _push a</div>
<div class="line">    call memory_allocate</div>
<div class="line">    add sp, 1</div>
<div class="line">    </div>
<div class="line">    _sfArg(push, 1) ;setup stack for a call to peLoader_initProcess</div>
<div class="line">    _push a </div>
<div class="line">    </div>
<div class="line">    _sfArg(c, 0)</div>
<div class="line">    </div>
<div class="line">    _sfLocal(push, 0)</div>
<div class="line">    _push a</div>
<div class="line">    _push c</div>
<div class="line">    call vfs_fRead</div>
<div class="line">    add sp, 3</div>
<div class="line">    </div>
<div class="line">    call peLoader_initImage</div>
<div class="line">    _pop c                      ;The base address of our memory allocated for our executable image</div>
<div class="line">    add sp, 1</div>
<div class="line">    </div>
<div class="line">    ife a, 0</div>
<div class="line">        jmp peLoader_loadImage_failed</div>
<div class="line">    </div>
<div class="line">    set a, c                    ;return base address of executable image</div>
<div class="line">    </div>
<div class="line">peLoader_loadImage_end:</div>
<div class="line">    _sfEnd()</div>
<div class="line">    ret</div>
<div class="line"></div>
<div class="line">peLoader_loadImage_failed:</div>
<div class="line">    _sfArg(y, 0)</div>
<div class="line">    </div>
<div class="line">    ;If initialization failed, deallocate the region of memory we were loading the executable into.</div>
<div class="line">    _sfLocal(push, 0)</div>
<div class="line">    _push c</div>
<div class="line">    call memory_free</div>
<div class="line">    add sp, 2</div>
<div class="line">    set a, 0</div>
<div class="line">    </div>
<div class="line">    jmp peLoader_loadImage_end</div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S112"></a>
peLoader_initImage</h2>
<p><a class="el" href="calling_conventions.html#cdecl">cdecl</a> STATUS peLoader_initImage(<code>IMAGE*</code> pImage, <code>FILE*</code> pSourceDirectory) <br/>
<br/>
<b>Description:</b><br/>
 Initializes and executes an executable image in memory. This routine will take the address of the loaded executable image in memory provided via the arguments, initializes the image's Import Address Table, adds it to the task chain, corrects its export table (adds its base address to the export rvas described in the export table) and creates a thread at its entrypoint. <br/>
</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pImage</td><td><code>IMAGE*</code> A pointer to the raw executable image in memory to Initializes. </td></tr>
    <tr><td class="paramname">pSourceDirectory</td><td><code>FILE*</code> A pointer to a file descriptor of the directory where dependencies are looked for. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>STATUS</code> Returns a 0 on error, and anything else otherwise. <br/>
</dd></dl>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line">    _sfBegin(0)</div>
<div class="line">    </div>
<div class="line">    _push i                                             ;Preserve the state of the i register so we do not corrupt it.</div>
<div class="line">    </div>
<div class="line">    _sfArg(i, 0)                                        ;Set I a pointer to the raw executale image</div>
<div class="line"></div>
<div class="line">    ifn [i], PEIMAGE_SIGNATURE                          ;Check for the proper signature in the header, if it isn&#39;t there, cause error</div>
<div class="line">        jmp peLoader_create_error</div>
<div class="line">    </div>
<div class="line">    add i, [i + PEIMAGE_OFFSET_RVA_IMPORT_TABLE]        ;Seek to the Images import table.</div>
<div class="line">    </div>
<div class="line">    ife i, 0                                            ;Skip initilizing the import table.</div>
<div class="line">        jmp peLoader_create_initImportTable_end</div>
<div class="line">    </div>
<div class="line">    ;Setup the image&#39;s import address table</div>
<div class="line">    peLoader_create_initImportTableLoop:</div>
<div class="line">        ife [i], PEIMAGE_INVALID_IMPORT                 ;If the current entry in the ModuleImport is equal to PEIMAGE_INVALID_IMPORT, it is the </div>
<div class="line">            jmp peLoader_create_initImportTable_end     ;end of the list, as PEIMAGE_INVALID_IMPORT is used to terminate the list</div>
<div class="line">    </div>
<div class="line">        _sfArg(push, 1)</div>
<div class="line">        _push i</div>
<div class="line">        call peLoader_findImageEx                       ;Locate the module we are importing from, and store the result in A</div>
<div class="line">        add sp, 2</div>
<div class="line">        </div>
<div class="line">        add i, PEIMAGE_NAMELEN                          ;Seek past the name entry of the executable image&#39;s ModuleImport structure</div>
<div class="line">                                                        ;and seek to the list of imported ordinals</div>
<div class="line">        </div>
<div class="line">        ;Loop through ModuleImport&#39;s ordinal entries and translate them to the appropriate corresponding address of the imported function.</div>
<div class="line">        peLoader_create_moduleImportLoop:</div>
<div class="line">            ife [i], PEIMAGE_INVALID_IMPORT                     ;If the current ordinal is equal to PEIMAGE_INVALID_IMPORT, end the loop as PEIMAGE_INVALID_IMPORT terminates the list of ordinals.</div>
<div class="line">                jmp peLoader_create_moduleImportLoop_end</div>
<div class="line"></div>
<div class="line">            set c, [a + PEIMAGE_OFFSET_RVA_EXPORT_TABLE]        ;Calculate the address of the export table we are importing from into C</div>
<div class="line">            </div>
<div class="line">            add c, a</div>
<div class="line">            add c, [i]                                          ;Add the ordinal number to the base address of the export table (thus calculating the address of the ordinals corresponding imported function)</div>
<div class="line">            set [i], [c]                                        ;Replace the ordinal value with the address of the import it refers to.</div>
<div class="line">            </div>
<div class="line">            add i, 1                                            ;Increase the cursor by one, moving to the next ordinal.</div>
<div class="line">            jmp peLoader_create_moduleImportLoop</div>
<div class="line">            </div>
<div class="line">            peLoader_create_moduleImportLoop_end:</div>
<div class="line">                add i, 1                                        ;Increase the cursor again, moving to the next ModuleImport structure.</div>
<div class="line">        </div>
<div class="line">        jmp peLoader_create_initImportTableLoop</div>
<div class="line"></div>
<div class="line">    peLoader_create_initImportTable_end:</div>
<div class="line">        </div>
<div class="line">        </div>
<div class="line">    </div>
<div class="line">    ;Correct export table of the executable image (add the base address)</div>
<div class="line">    _sfArg(i, 0)                                                ;Set I to point to the base address of the executable image being loaded    </div>
<div class="line"></div>
<div class="line">    ife [i + PEIMAGE_OFFSET_RVA_EXPORT_TABLE], 0</div>
<div class="line">        jmp peLoader_create_fixExport_end                       ;If there is no defined rva to the export table, skip fixing of relocations.</div>
<div class="line">        </div>
<div class="line">    add i, [i + PEIMAGE_OFFSET_RVA_EXPORT_TABLE]                ;Add to I, seeking to its export table.</div>
<div class="line">        </div>
<div class="line">    peLoader_create_fixExportLoop:</div>
<div class="line">        ife [i], PEIMAGE_INVALID_EXPORT                         ;If current export entry is invalid, it is the end of the loop since PEIMAGE_INVALID_EXPORT is used to terminate the export list.</div>
<div class="line">            jmp peLoader_create_fixExport_end</div>
<div class="line">            </div>
<div class="line">        _sfArg(c, 0)                                            ;Add to the entry the base address of the executable image.</div>
<div class="line">        add [i], c</div>
<div class="line">        add i, 1                                                ;Advance the cursor by one, thus seeking to the next export entry.</div>
<div class="line">        jmp peLoader_create_fixExportLoop</div>
<div class="line">    peLoader_create_fixExport_end:</div>
<div class="line">    </div>
<div class="line">    ;Calculate EP and create thread there.</div>
<div class="line">    _sfArg(i, 0)                                                ;Calculate the offset to the executable image&#39;s rvaEntrypoint member</div>
<div class="line"></div>
<div class="line">    ife [i + PEIMAGE_OFFSET_RVA_ENTRY_POINT], 0                 ;IF EP equals base i.e, RVA was zero</div>
<div class="line">        jmp peLoader_create_noEntryPoint                        ;No entrypoint was set, skip step.</div>
<div class="line">    </div>
<div class="line">    ifb [i + PEIMAGE_OFFSET_PEFLAGS], PEIMAGE_PEFLAG_FORCEINIT</div>
<div class="line">        jmp peLoader_create_forceInit</div>
<div class="line">    </div>
<div class="line">    _push i</div>
<div class="line">    add i, [i + PEIMAGE_OFFSET_RVA_ENTRY_POINT]                 ;Add the rva to the image&#39;s entrypoint</div>
<div class="line">    _push i                                                     ;and push it to the stack as well for a call to create thread</div>
<div class="line">    call threading_createThread</div>
<div class="line">    add sp, 2</div>
<div class="line">    </div>
<div class="line">    jmp peLoader_create_noEntryPoint</div>
<div class="line">    </div>
<div class="line">peLoader_create_forceInit:</div>
<div class="line">    add i, [i + PEIMAGE_OFFSET_RVA_ENTRY_POINT]                 ;Add the rva to the image&#39;s entrypoint</div>
<div class="line">    _push i </div>
<div class="line">    call [i + PEIMAGE_OFFSET_RVA_ENTRY_POINT]</div>
<div class="line">    add sp, 1</div>
<div class="line">    </div>
<div class="line">peLoader_create_noEntryPoint:</div>
<div class="line">    ;Terminate linked list by setting Next entry to INVALID</div>
<div class="line">    _sfArg(i, 0)</div>
<div class="line">    set [i + PEIMAGE_OFFSET_NEXT], PEIMAGE_INVALID_NEXT</div>
<div class="line">    </div>
<div class="line">    call peLoader_findLastImage                                 ;Locate the last executable image in the linked list of executable images</div>
<div class="line">    _sfArg([a + PEIMAGE_OFFSET_NEXT], 0)                        ;Set its next entry to the executable image we just loaded (add this executable image to the chain.)</div>
<div class="line"></div>
<div class="line">peLoader_create_end:</div>
<div class="line"></div>
<div class="line">    _pop i                                                      ;Restore state of I register</div>
<div class="line">    _sfEnd()</div>
<div class="line">    ret</div>
<div class="line">        </div>
<div class="line">peLoader_create_error:</div>
<div class="line">    set a, 0                                                    ;return a zero on error</div>
<div class="line">    jmp peLoader_create_end </div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S113"></a>
peLoader_findLastImage</h2>
<p><a class="el" href="calling_conventions.html#cdecl">cdecl</a> void* peLoader_findLastImage() <br/>
<br/>
<b>Description:</b><br/>
 Locates the last executable image in the linked list of initialized executable images (whose root node is defined in peLoader_root) and returns the base address of that image. <br/>
</p>
<dl class="section return"><dt>Returns</dt><dd><code>void*</code> Returns address of the last executable image in the list of initialized executable images. <br/>
</dd></dl>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line"><span class="keyword">set</span> a, [peLoader_root]                                  ;Set a to the root note of the linked list</div>
<div class="line"></div>
<div class="line">peLoader_findLastImage_loopFindNext:</div>
<div class="line">    ife [a + PEIMAGE_OFFSET_NEXT], PEIMAGE_INVALID_NEXT ;If the current executable image has an invalid next entry, it is the last entry in the chain.</div>
<div class="line">        jmp peLoader_findLastImage_loopFindNext_end</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">set</span> a, [a + PEIMAGE_OFFSET_NEXT]                    ;Otherwise, seek to the next entry.</div>
<div class="line">    jmp peLoader_findLastImage_loopFindNext</div>
<div class="line">    </div>
<div class="line">peLoader_findLastImage_loopFindNext_end:</div>
<div class="line"></div>
<div class="line">ret </div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S114"></a>
peLoader_findImage</h2>
<p><a class="el" href="calling_conventions.html#cdecl">cdecl</a> STATUS peLoader_findImage(<code>Char*</code> sNameSinglebyte) <br/>
<br/>
<b>Description:</b><br/>
 Determines the address of an executable in memory and returns the base address of that image. This is done by walking through the linked list and comapring each entries name with the one we are looknig for. <br/>
</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">sNameSinglebyte</td><td><code>Char*</code> Name of the module to locate the base address of in ascii single-byte. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>STATUS</code> Returns base address of executable image in memory, or zero if the entry was not found. <br/>
</dd></dl>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line">    _sfBegin(0)</div>
<div class="line">    </div>
<div class="line">    _push i                                             ;Preserve the state of the i register so we do not corrupt it.</div>
<div class="line">    </div>
<div class="line">    _sfArg(push, 0)                                     ;Setup the stack frame for a call to compare <span class="keywordtype">string</span>. This pushes the address of the name we&#39;re looking for</div>
<div class="line">    _push 0                                             ;and this is an null place holder, where we will store the address of an executable image&#39;s name in as we step through linked list of executable images.</div>
<div class="line">    </div>
<div class="line">    set i, [peLoader_root]                              ;Set i to the root entry in the linked list</div>
<div class="line">    </div>
<div class="line">    peLoader_findModule_loop:</div>
<div class="line">        ife i, PEIMAGE_INVALID_NEXT                     ;If current entry is invalid (i.e, if the current entry is the last entry)</div>
<div class="line">            jmp peLoader_findModule_error               ;and we haven&#39;t located the image, return error</div>
<div class="line">            </div>
<div class="line">        set [sp], i                                     ;Calculate the address of the images name, and store it on the stack</div>
<div class="line">        add [sp], PEIMAGE_OFFSET_NAME</div>
<div class="line">        </div>
<div class="line">        call string_sbCompare                           ;compare the two strings</div>
<div class="line">        </div>
<div class="line">        ife a, 0                                        ;if the two strings are equal</div>
<div class="line">            jmp peLoader_findModule_loop_end            ;exit the loop, and proceed to return the executable image&#39;s base address to the caller</div>
<div class="line">        </div>
<div class="line">        set i, [i + PEIMAGE_OFFSET_NEXT]</div>
<div class="line">        jmp peLoader_findModule_loop</div>
<div class="line">        </div>
<div class="line">    peLoader_findModule_loop_end:</div>
<div class="line">    </div>
<div class="line">    </div>
<div class="line">    add sp, 2                                           ;Cleanup stack after call to string_compare</div>
<div class="line">    set a, i                                            ;Set a to i (i is equal to the base address of the image.)</div>
<div class="line"></div>
<div class="line">peLoader_findImage_end:</div>
<div class="line">    _pop i                                              ;restore the state of the i register</div>
<div class="line">    _sfEnd()</div>
<div class="line">    ret</div>
<div class="line"></div>
<div class="line">peLoader_findModule_error:</div>
<div class="line">    add sp, 2</div>
<div class="line">    set a, 0</div>
<div class="line">    </div>
<div class="line">    jmp peLoader_findImage_end </div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S115"></a>
peLoader_findImageEx</h2>
<p><a class="el" href="calling_conventions.html#cdecl">cdecl</a> void* peLoader_findImageEx(<code>char*</code> sNameSinglebyte, <code>FILE*</code> pSourceDirectory) <br/>
<br/>
<b>Description:</b><br/>
 Determines the address of an executable (if it is not already in memory, it is loaded into memory) and returns the base address of that image. <br/>
</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">sNameSinglebyte</td><td><code>char*</code> Name of the module to locate the base address of in ascii single byte. </td></tr>
    <tr><td class="paramname">pSourceDirectory</td><td><code>FILE*</code> The source directory to look for the executable image in, if it is not found to be already loaded in memory </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>void*</code> Returns base address of executable image in memory, or zero if the entry was not found. <br/>
</dd></dl>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line">    _sfBegin(VFS_FILE_SIZE)</div>
<div class="line">    </div>
<div class="line">    _sfArg(push, 0)</div>
<div class="line">    call peLoader_findImage</div>
<div class="line">    add sp, 1</div>
<div class="line">    </div>
<div class="line">    ifn a, 0</div>
<div class="line">        jmp peLoader_findImageEx_end</div>
<div class="line">    </div>
<div class="line">    _sfLocalPtr(push, VFS_FILE_OFFSET_LASTMEMBER)       </div>
<div class="line">    _sfArg(push, 0)</div>
<div class="line">    _sfArg(push, 1)</div>
<div class="line">    call vfs_fOpenFile</div>
<div class="line">    add sp, 3</div>
<div class="line">    </div>
<div class="line">    ife a, 0</div>
<div class="line">        jmp peLoader_findImageEx_end</div>
<div class="line">    </div>
<div class="line">    _sfArg(push, 1)</div>
<div class="line">    _sfLocalPtr(push, VFS_FILE_OFFSET_LASTMEMBER)</div>
<div class="line">    call peLoader_loadImage</div>
<div class="line">    add sp, 2</div>
<div class="line">    </div>
<div class="line">peLoader_findImageEx_end:</div>
<div class="line">    _sfEnd()</div>
<div class="line">    ret </div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S116"></a>
peLoader_findExport</h2>
<p><a class="el" href="calling_conventions.html#cdecl">cdecl</a> void* peLoader_findExport(<code>void*</code> pBaseAddress, <code>WORD</code> wOrdinal) <br/>
<br/>
<b>Description:</b><br/>
 Determines the address of an executable's export given the export ordinal. <br/>
</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pBaseAddress</td><td><code>void*</code> Base address of the executable image to search for the ordinal in. </td></tr>
    <tr><td class="paramname">wOrdinal</td><td><code>WORD</code> Ordinal corresponding to the export to find. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd><code>void*</code> Returns address of the data exported at that ordinal. <br/>
</dd></dl>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line">_sfBegin(0)</div>
<div class="line"></div>
<div class="line">_sfArg(a, 0)</div>
<div class="line">add a, [a + PEIMAGE_OFFSET_RVA_EXPORT_TABLE]</div>
<div class="line">_sfArgAdd(a, 1)</div>
<div class="line"></div>
<div class="line">set a, [a]</div>
<div class="line"></div>
<div class="line">_sfEnd()</div>
<div class="line">ret</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="md__code.html">Code</a></li>
    <li class="footer">Generated on Sat Apr 13 2013 17:37:42 for DarkCPU by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
