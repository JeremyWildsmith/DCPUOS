<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>DarkCPU: $title</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">DarkCPU
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('main10c.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#mainmoddet">Module Details</a></li>
<li class="level1"><a href="#DASMDOC_S4">Data</a><ul><li class="level2"><a href="#DASMDOC_S5">kernel_image_header</a></li>
<li class="level2"><a href="#DASMDOC_S6">kernel_sBootstrapName</a></li>
<li class="level2"><a href="#DASMDOC_S7">kernel_size</a></li>
</ul>
</li>
<li class="level1"><a href="#DASMDOC_S8">Functions</a><ul><li class="level2"><a href="#DASMDOC_S9">kernel_main</a></li>
<li class="level2"><a href="#DASMDOC_S10">kernel_initThreadEp</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h2>main10c</h2>
<h2>Main</h2>
<h1><a class="anchor" id="mainmoddet"></a>
Module Details</h1>
<p><a class="anchor" id="BootCode"></a></p>
<p>This module contains the boot code for the kernel image, and is the first module executed in the kernel. This module is responsible for setting up kernel critical components such as the memory manager, device manager, interrupts aswell as initializing the threading manager and the clock driver. </p>
<dl class="section author"><dt>Author</dt><dd>Jeremy (0x10cforums.com) </dd></dl>
<dl class="section version"><dt>Version</dt><dd>1.0 </dd></dl>
<dl class="section date"><dt>Date</dt><dd>Dec, 14, 2012 </dd></dl>
<dl class="section warning"><dt>Warning</dt><dd>Use caution with use of modules such as the MemoryManager or DeviceManager as they may not yet be initilized. Also note that if you are not inside of a thread (i.e you are still in the <a class="el" href="main10c.html#BootCode">BootCode</a> main routine) use of any threading module such as Mutex or <a class="el" href="threading10c.html#ThreadingManager">ThreadingManager</a> may cause issues unless these routines explicitly state they can be used outside of a thread. </dd>
<dd>
The bootcode is under the assumption that the initrd is mounted at index 0 when it is executed.</dd></dl>
<h1><a class="anchor" id="DASMDOC_S4"></a>
Data</h1>
<hr/>
 <h2><a class="anchor" id="DASMDOC_S5"></a>
kernel_image_header</h2>
<p><code>IMAGE*</code> kernel_image_header <br/>
<br/>
<b>Description:</b><br/>
 kernel_image_header A pointer to the base of the Kernel Image Header <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"></div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S6"></a>
kernel_sBootstrapName</h2>
<p><code>CHAR*</code> kernel_sBootstrapName <br/>
<br/>
<b>Description:</b><br/>
 kernel_sBootstrapName A pointer to a string describing the name of the bootstrap in the initrd. <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line">dat 0x6f62, 0x746f, 0x7473, 0x6172, 0x0070 ;cstring of <span class="stringliteral">&#39;bootstrap&#39;</span></div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S7"></a>
kernel_size</h2>
<p><code>VOID*</code> kernel_size <br/>
<br/>
<b>Description:</b><br/>
 Can be interpreted as either a pointer to the end of the kernel, or, since the kernel is loaded at base address zero, the size of the kernel image. <br/>
<br/>
</p>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line">:__IMGSIZE </div>
</div><!-- fragment --><h1><a class="anchor" id="DASMDOC_S8"></a>
Functions</h1>
<hr/>
 <h2><a class="anchor" id="DASMDOC_S9"></a>
kernel_main</h2>
<p><a class="el" href="calling_conventions.html#nakedcall">nakedcall</a> VOID kernel_main() <br/>
<br/>
<b>Description:</b><br/>
 The entrypoint of the kernel's bootcode. This routine is responsible for initilizing the memory manager, reserving the kernel region as well as preparing the Interrupt Service Routine and initilizing other critical modules of the kernel. <br/>
</p>
<dl class="section return"><dt>Returns</dt><dd><code>VOID</code> No return value. <br/>
</dd></dl>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line">_push 0x1234</div>
<div class="line">call memory_init                    ;Initilize the memory manager</div>
<div class="line"></div>
<div class="line">_push kernel_size                   ;Reserve the kernel memory region</div>
<div class="line">_push 0</div>
<div class="line">call memory_reserve</div>
<div class="line">add sp, 2</div>
<div class="line"></div>
<div class="line">call ramddssi_init</div>
<div class="line"></div>
<div class="line">_push kernel_image_header</div>
<div class="line">_push 0                             ;Create a thread <span class="keywordflow">for</span> the kernel to branch off to.</div>
<div class="line">_push kernel_initThreadEp</div>
<div class="line">call threading_createThread</div>
<div class="line">add sp, 3</div>
<div class="line"></div>
<div class="line">call device_init                    ;Initlize device manager</div>
<div class="line">call userInterfaceState_init</div>
<div class="line"></div>
<div class="line">;Allocate memory <span class="keywordflow">for</span> kernel state. All <span class="keyword">this</span> code should disappear soon...</div>
<div class="line">_push USERINTERFACESTATE_SIZE</div>
<div class="line">call memory_allocate</div>
<div class="line">add sp, 1</div>
<div class="line"><span class="keyword">set</span> [kernelState], a</div>
<div class="line"></div>
<div class="line">_push kernelInputHandler</div>
<div class="line">_push 0</div>
<div class="line">_push a</div>
<div class="line">call userInterfaceState_createState</div>
<div class="line">add sp, 3</div>
<div class="line"></div>
<div class="line">_push a</div>
<div class="line">call userInterfaceState_setActive</div>
<div class="line">call userInterfaceState_getVram</div>
<div class="line">add sp, 1</div>
<div class="line"></div>
<div class="line">_push 0</div>
<div class="line">_push startupMessage</div>
<div class="line">_push a</div>
<div class="line">call graphics_writeString</div>
<div class="line">add sp, 3</div>
<div class="line"></div>
<div class="line">;Initilize keyboard, clock and interrupt handler modules</div>
<div class="line">call keyboard_init</div>
<div class="line"></div>
<div class="line">_push 5                 ;Fire off interrupt timer every 15ths of a second.</div>
<div class="line">call clock_init</div>
<div class="line">add sp, 1</div>
<div class="line"></div>
<div class="line">call interrupt_enable</div>
<div class="line">_threading_endCycle()   ;Pass control on to the next thread (or idle <span class="keywordflow">if</span> there are none.</div>
</div><!-- fragment --><hr/>
 <h2><a class="anchor" id="DASMDOC_S10"></a>
kernel_initThreadEp</h2>
<p><a class="el" href="calling_conventions.html#cdecl">cdecl</a> VOID kernel_initThreadEp() <br/>
<br/>
<b>Description:</b><br/>
 The entrypoint of the kernel's main thread. This routine is the origin of the first thread created, but not guaranteed to be the first executed. It performs other startup tasks such as mounting the initrd and loading the bootstrap. <br/>
</p>
<dl class="section return"><dt>Returns</dt><dd><code>VOID</code> No return value <br/>
</dd></dl>
<p><b>Code:</b> </p>
<div class="fragment"><div class="line">;important that any init code that might through interrupts is done here (modules depend on threading system)</div>
<div class="line"></div>
<div class="line">_sfBegin(VFS_FILE_SIZE * 2)     ;Allocate enough space <span class="keywordflow">for</span> file descriptor</div>
<div class="line"></div>
<div class="line">_push rsfs_header</div>
<div class="line">_push ramddssi_header</div>
<div class="line">call vfs_createMount</div>
<div class="line">add sp, 2</div>
<div class="line"></div>
<div class="line">_sfLocalPtr(push, VFS_FILE_OFFSET_LASTMEMBER)   ; Push pointer to bootstrap descriptor onto stack.</div>
<div class="line">_push 0</div>
<div class="line">call vfs_fGetRoot</div>
<div class="line">add sp, 2</div>
<div class="line"></div>
<div class="line">_sfLocalPtr(push, VFS_FILE_OFFSET_LASTMEMBER + VFS_FILE_SIZE) ; Push pointer to dest file descriptor.</div>
<div class="line">_push kernel_sBootstrapName</div>
<div class="line">_sfLocalPtr(push, VFS_FILE_OFFSET_LASTMEMBER)   ; Push pointer to parent directory file descriptor.</div>
<div class="line">call vfs_fOpenFile</div>
<div class="line">add sp, 3</div>
<div class="line"></div>
<div class="line">ife a, 0                                        ;Throw an error, bootstrap was not found</div>
<div class="line">    <span class="keywordtype">int</span> INTERRUPT_MESSAGE_KERNELERROR</div>
<div class="line"></div>
<div class="line">_sfLocalPtr(push, VFS_FILE_OFFSET_LASTMEMBER)   ; Push pointer to parent directory file descriptor.</div>
<div class="line">_sfLocalPtr(push, VFS_FILE_OFFSET_LASTMEMBER + VFS_FILE_SIZE) ; Push pointer to bootstrap file descriptor.</div>
<div class="line">call peLoader_loadImage</div>
<div class="line">add sp, 2</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">;unmount ramdisk</div>
<div class="line">_sfLocalPtr(push, VFS_FILE_OFFSET_LASTMEMBER)   ; Push pointer to parent directory file descriptor.</div>
<div class="line">call vfs_endMount</div>
<div class="line">add sp, 1</div>
<div class="line"></div>
<div class="line">;Cleanup ramdisk</div>
<div class="line">call ramddssi_deinit</div>
<div class="line"></div>
<div class="line">_sfEnd()</div>
<div class="line">ret</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="md__code.html">Code</a></li>
    <li class="footer">Generated on Tue Apr 9 2013 21:10:06 for DarkCPU by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.3.1 </li>
  </ul>
</div>
</body>
</html>
